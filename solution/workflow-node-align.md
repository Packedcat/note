## 节点对齐方案

### 方案设计

#### 辅助线对齐

##### 目标拆解

- 启发式吸附对齐
  - 节点移动/缩放过程中，检测其边缘/中心与其他节点的边缘/中心是否接近
  - 尺寸、位置的辅助线显示
  - 依据吸附信息重新设置节点位置、尺寸
- 智能间距排布
  - 当某个节点移动接近某些节点时，动态计算并调整这些节点的位置，使其与移动节点之间自动保持等距排列
  - 等距参考线显示
  - 依据吸附信息重新设置节点位置


##### 实现思路与步骤

1. 在节点的拖动事件中处理位置对齐检测

   1. 获得当前拖动节点的几何属性（Geometric）
   1. 遍历其他节点的几何属性
   1. 分别执行横向与纵向的 snapping
   1. 应用新的坐标位置到状态中心
2. 在节点的缩放事件中处理尺寸对齐检测

   1. 获取
3. <del>在节点的缩放变化中处理位置对齐检测</del>
4. 节点拖动时处理智能间距

   1. 准备所有节点的几何信息
   2. <del>使用空间索引算法查找邻近节点</del>（待有规模需求再接入）
   3. 分组识别
      1. 选取 y 轴碰撞的节点

      2. 对这些节点按 x 坐标中心排序，构成 “水平组”

      3. 选取 x 轴碰撞的节点

      4. 对这些节点按 y 坐标中心排序，构成 “垂直组”

   4. 使用拖动节点初始化候选列表，分别选取组内拖动节点位置左右至多两个与当前候选列表列不重叠的节点
   5. 等间距吸附位置计算
      1. 按拖动节点置于最左/中间/最右三种情况计算吸附的坐标（候选不足则跳过）
5. 辅助线绘制
   1. 吸附时绘制视口尺寸的一像素辅助线
   2. 缩放时绘制对齐边的等距线
   3. 智能间距时绘制候选节点间的等距线


##### 问题记录

| 问题                                 | 解决方式（下一步动作）       | 状态 |
| ------------------------------------ | ---------------------------- | ---- |
| 拖动时自动分布排列与吸附对齐的优先度 |                              |      |
| 多辅助线如何在reactflow范围内绘制    |                              |      |
| 参数坐标转化                         |                              |      |
| React-flow 如何获得节点的尺寸信息    |                              |      |
| 坐标可以匹配多个节点                 |                              |      |
| drag 结束后节点偏移问题              | 没有对 dragEnd 事件处理 snap | ✅    |
| 视口缩放后辅助线如何执行偏移         |                              |      |
| 目前缩放的指针跟随不准确问题         |                              |      |
| 如何在缩放事件中修改节点的尺寸       |                              |      |

##### Q&A

Q：如何获得尺寸与位置，不同方法有什么区别？

Q：NodeResizer `onResize` 以及 ReactFlow 的 `onNodeDrag` 事件状态变化以及句柄调用顺序？

A：`xyflow/packages/system/src/xyresizer/XYResizer.tsL292`先执行 `onResize` 再执行 `onChange->triggerNodeChanges`，所以即使通过 onResize 事件修改了节点尺寸，还是会被后续 `onChange` 重置；`xyflow/packages/system/src/xydrag/XYDrag.tsL198` 先执行 `updateNodePositions->triggerNodeChanges` 再触发的 `onNodeDrag`，所以可以在 `onNodeDrag` 中修改节点的位置

Q：如何获取拖动节点的附近节点？

A：

Q：辅助线绘制如何处理视口的缩放？

### Reference

[Bounding volume](https://en.wikipedia.org/wiki/Bounding_volume)

[碰撞检测](https://learnopengl-cn.github.io/06%20In%20Practice/2D-Game/05%20Collisions/02%20Collision%20detection/)

### 产品方案

[节点类型新增](http://10.51.96.15/zentao/story-view-7445.html)

[工作流交互优化](http://10.51.96.15/zentao/story-view-7431.html)